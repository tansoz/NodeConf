server{

    {{PORT}}
    server_name *.node.rommhui.com;
    server_name node.rommhui.com;
    server_name ~^(.+)node\.rommhui\.com$;
    server_name *.shandisk.rommhui.com;
    server_name *.10010.com;
    server_name *.10155.com;
    server_name *.wo.cn;
    server_name *.17wo.cn;
    server_name *.wostore.cn;
    server_name *.wo.com.cn;
    server_name *.189.cn;
    server_name *.cibntv.net;
    server_name *.iqiyi.com;
    server_name *.taobao.com;
    server_name *.aliyun.com;
    server_name *.tbcdn.com;


    resolver 8.8.8.8;
    
    access_log off;
    
    set $update "{{DATE}}";
    
    add_header "X-Node-Ver" $update always;
    
    location /files/ {
        alias /var/www/html/;
    }
    
    location /shandisk/ {
        proxy_pass http://127.0.0.1:8880/;
        proxy_set_header Host 127.0.0.1:8880;

        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    location ~ ^/(\d+\.[a-zA-Z0-9]+\.[a-zA-Z0-9]+)(:\d+)?/ {

        set $name "$1.node.rommhui.com$2";
        
        if ($request_uri ~ ^/(\d+\.[a-zA-Z0-9]+\.[a-zA-Z0-9]+)(:\d+)?/(.*)$){
            proxy_pass http://$name/$3;
        }

        proxy_set_header Host $1.node.rommhui.com;

        proxy_redirect off;
        proxy_ssl_server_name on;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        add_header X-Cache $upstream_cache_status;
        add_header Cache-Control no-cache;
    }
    
    location ~^/cf/(.*)$ {
        set $pass_cookie "__ew_fiddle_preview=27b81fbfcab67e0f7f5bb1ed531cf286773ead641a1c1ee4f94c7b1b395dd6d81node.tansoz.workers.dev; $http_cookie";
        proxy_pass https://cloudflareworkers.cloudflareworkers.com/$1;
        proxy_set_header "Cookie" $pass_cookie;
        proxy_http_version 1.1;
    }
    
    location ~ ^/(workers/)?(CORS/)?(https?)[:/]+(\(([^/()]+)\))?([^/]+) {
        
        set $cors "";
        set $workers "";
        set $r_scheme "http";
        set $r_addr "1.1.1.30";
        set $r_host $r_addr;
        set $r_uri "/";
        set $pass "";
        
        if ($request_uri ~ ^/(workers/)?(CORS/)?(https?)?[:/]*(\(([^/()]+)\))?([^/]+)(.*)$){
            
            set $workers $1;
            set $cors $2;
            set $r_scheme $3;
            set $r_addr $5;
            set $r_host $6;
            set $r_uri $7;
        }
        
        if ($r_addr ~ ^$){
            set $r_addr $r_host;
        }
        
        if ($r_uri ~ ^$){
            set $r_uri "/";
        }
        
        set $pass $r_scheme://$r_addr$r_uri;
        set $pass_host $r_host;
        set $workersscheme "0";
        set $pass_cookie $http_cookie;
        if ($r_scheme ~ ^https$){
            set $workersscheme "1";
        }
        if ($workers ~ ^.+$){
            set $pass_host "cloudflareworkers.cloudflareworkers.com";
            set $pass "https://$pass_host$r_uri";
            set $pass_cookie "__ew_fiddle_preview=27b81fbfcab67e0f7f5bb1ed531cf286773ead641a1c1ee4f94c7b1b395dd6d8$workersscheme$r_addr; $http_cookie";
        }
        proxy_ssl_server_name on;
        proxy_pass $pass;
        
        proxy_set_header Host $pass_host;
        
        proxy_set_header "User-Agent" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36";
        proxy_set_header "Cookie" $pass_cookie;
        proxy_set_header "sec-fetch-dest" "document";
        proxy_set_header "sec-fetch-mode" "navigate";
        proxy_set_header "sec-fetch-site" "none";
        
        proxy_redirect ~^(.*)$ $scheme://$http_host/$1;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        add_header X-Cache $upstream_cache_status;
        add_header Cache-Control no-cache;
        
        add_header x-workers $workers;
        add_header x-cookies $pass_cookie;
        
        if ($cors ~ ^.+$){
            add_header "Access-Control-Allow-Origin" "*";
        }
        
    }

    location = /self {
        proxy_pass http://127.0.0.1:53535/;
        proxy_set_header Host 127.0.0.1:53535;

        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        add_header X-Cache $upstream_cache_status;
        add_header Cache-Control no-cache;
    }
    
    location /location/ {
        set $location "http://www.cloudflare.com/";
        if ($request_uri ~ /location/(.+)$){
            set $location $1;
        }
        add_header "access-control-allow-origin" "*" always;
        add_header "access-control-allow-methods" "GET, POST, OPTIONS, PUT, DELETE" always;
        return 301 $location;
    }

    location / {
        proxy_pass http://www.cloudflare.com;
        proxy_set_header Host 1.1.1.30;

        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        add_header X-Cache $upstream_cache_status;
        add_header Cache-Control no-cache;
    }

}
